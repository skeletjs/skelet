const getRootClass = require('skelet-utils/lib/getRootClass')

/**
 * Creates a `final` function property on an object, which means it can not be reassigned,
 * nor overridden by a subclass.
 *
 *
 * This is done by utilizing whatever is available at the current time:
 *  - instanceof
 *  - getter/setter with configurable: false
 *
 * @param instance    The object to apply this to
 * @param function    The function to make final
 *
 *
 */
function final (instance, fn) {
  if (!(fn instanceof Object)) throw new TypeError('instance must be an object')
  if (typeof fn !== 'function') throw new TypeError('fn must be a function')

  // Check wither a subclass is attempting to override this function
  if (instance[fn.name]) {
    throw new Error(`You are not allowed to override ${getRootClass(instance).constructor.name}.${fn.name}`)
  }

  // Install the function as a unconfigurable getter
  Object.defineProperty(instance, fn.name, {
    get: function () { return fn },
    set: () => { throw new Error(`You are not allowed to modify ${instance.constructor.name}.${fn.name}`) },
    configurable: false
  })
}

module.exports = final
